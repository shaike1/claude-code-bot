#!/usr/bin/expect -f

set timeout 120
log_user 1

spawn claude /login

puts "=== STARTING CLAUDE LOGIN TEST ==="

expect {
    "Choose the text style" {
        puts "\n=== THEME SELECTION SCREEN ==="
        send "1\r"
        expect {
            "Choose login method" {
                puts "\n=== LOGIN METHOD SELECTION ==="
                send "1\r"
                expect {
                    -re "https://.*" {
                        puts "\n=== FOUND URL: $expect_out(0,string) ==="
                        exp_continue
                    }
                    "console.anthropic.com" {
                        puts "\n=== FOUND CONSOLE.ANTHROPIC.COM (generic URL) ==="
                        exp_continue
                    }
                    "Invalid API key" {
                        puts "\n=== INVALID API KEY MESSAGE ==="
                        exp_continue
                    }
                    timeout {
                        puts "\n=== TIMEOUT IN LOGIN METHOD ==="
                    }
                }
            }
            "Invalid API key" {
                puts "\n=== ALREADY SHOWS INVALID API KEY ==="
            }
            timeout {
                puts "\n=== TIMEOUT AFTER THEME SELECTION ==="
            }
        }
    }
    "Choose login method" {
        puts "\n=== DIRECT TO LOGIN METHOD ==="
        send "1\r"
        expect {
            -re "https://.*" {
                puts "\n=== FOUND URL: $expect_out(0,string) ==="
                exp_continue
            }
            "console.anthropic.com" {
                puts "\n=== FOUND CONSOLE.ANTHROPIC.COM (generic URL) ==="
                exp_continue
            }
            timeout {
                puts "\n=== TIMEOUT IN DIRECT LOGIN ==="
            }
        }
    }
    "Invalid API key" {
        puts "\n=== INVALID API KEY - NO LOGIN FLOW ==="
    }
    timeout {
        puts "\n=== TIMEOUT AT START ==="
        exit 1
    }
}

puts "\n=== TEST COMPLETE ==="
sleep 2